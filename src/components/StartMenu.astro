---
// StartMenu component - Displays the initial overlay before game starts
---

<div
  id="start-menu"
  class="fixed inset-0 z-50 flex flex-col items-center justify-center text-center gap-8 bg-black/90 text-white transition-opacity duration-500"
  data-game-state="initial"
>
  <div class="absolute inset-0">
    {/* Dark overlay */}
    <div
      class="absolute inset-0 bg-linear-to-b from-black/70 via-black/60 to-black/90"
    >
    </div>
    {/* Vignette effect */}
    <div
      class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,transparent_0%,black_100%)]"
    >
    </div>
  </div>
  <div
    class="absolute inset-0 opacity-10"
    style={{
      backgroundImage: `
            linear-gradient(rgba(0, 255, 0, 0.3) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 0, 0.3) 1px, transparent 1px)
          `,
      backgroundSize: "50px 50px",
    }}
  >
  </div>
  <div
    class="absolute top-2 left-2 w-32 h-32 border-t-2 border-l-2 border-green-500/40"
  >
  </div>
  <div
    class="absolute top-2 right-2 w-32 h-32 border-t-2 border-r-2 border-green-500/40"
  >
  </div>
  <div
    class="absolute bottom-2 left-2 w-32 h-32 border-b-2 border-l-2 border-green-500/40"
  >
  </div>
  <div
    class="absolute bottom-2 right-2 w-32 h-32 border-b-2 border-r-2 border-green-500/40"
  >
  </div>
  <div class="relative z-10 flex flex-col gap-10">
    <div class="flex flex-col gap-6">
      <div class="flex items-center justify-center gap-4 mb-4">
        <div
          class="h-px w-20 bg-linear-to-r from-transparent to-green-500"
          data-fg-b7rw20="0.8:1.6670:/App.tsx:61:13:2802:76:e:div"
        >
        </div>
        <h2 class="px-4 py-1 uppercase border border-green-500/50 bg-black/50">
          Classified
        </h2>
        <div
          class="h-px w-20 bg-linear-to-l from-transparent to-green-500"
          data-fg-b7rw24="0.8:1.6670:/App.tsx:65:13:3088:76:e:div"
        >
        </div>
      </div>
      <h1
        class="text-7xl font-black tracking-wider mb-2 text-transparent bg-clip-text bg-gradient-to-b from-gray-200 to-gray-400 drop-shadow-2xl"
      >
        F-117
      </h1>
      <h2
        class="text-4xl font-black uppercase tracking-[0.3em] text-green-400 drop-shadow-[0_0_20px_rgba(34,197,94,0.5)]"
      >
        Nighthawk
      </h2>
    </div>
    <div class="space-y-3 w-full max-w-md">
      <button
        id="start-button"
        class="group relative w-full px-8 py-4 border border-green-500/30 cursor-pointer bg-black/40 backdrop-blur-sm hover:bg-green-500/10 hover:border-green-400 transition-all duration-200"
        style="clip-path: polygon(0px 0px, calc(100% - 12px) 0px, 100% 12px, 100% 100%, 12px 100%, 0px calc(100% - 12px));"
      >
        <span
          class="absolute inset-0 overflow-hidden opacity-0 group-hover:opacity-100 transition-opacity"
        >
          <span
            class="absolute inset-0 bg-linear-to-b from-transparent via-green-400/20 to-transparent animate-scan"
          >
          </span>
        </span>
        <span class="relative flex items-center gap-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-play w-5 h-5 text-green-400 group-hover:text-green-300 transition-colors"
            ><polygon points="6 3 20 12 6 21 6 3"></polygon></svg
          ><span
            class="text-gray-200 group-hover:text-white tracking-widest transition-colors"
            >Start Mission</span
          ><span class="ml-auto text-green-500/50 font-mono text-sm">[01]</span>
        </span>
        <div
          class="absolute top-0 right-0 w-3 h-3 border-t border-r border-green-400 opacity-0 group-hover:opacity-100 transition-opacity"
        >
        </div>
        <div
          class="absolute bottom-0 left-0 w-3 h-3 border-b border-l border-green-400 opacity-0 group-hover:opacity-100 transition-opacity"
        >
        </div>
      </button>
    </div>
  </div>

  <script>
    const startMenu = document.getElementById("start-menu");
    const startButton = document.getElementById("start-button");

    if (startMenu && startButton) {
      // Notify the game that we're in "waiting to start" state
      if (!window.gameAPI) {
        window.gameAPI = {};
      }
      window.gameAPI.gameStarted = false;
      window.gameAPI.playerCanMove = false;
      window.gameAPI.missilesActive = false;

      let isProcessingStart = false;

      const handleStart = () => {
        // Prevent multiple invocations
        if (isProcessingStart) {
          return;
        }
        isProcessingStart = true;

        const isRestart = startMenu.dataset.gameState === "gameover";

        // Reset game state if restarting
        if (isRestart && window.gameAPI?.restart) {
          window.gameAPI.restart();
        }

        // Allow player to move immediately
        if (window.gameAPI) {
          window.gameAPI.playerCanMove = true;
        }

        // Fade out the menu
        startMenu.style.opacity = "0";
        startMenu.style.pointerEvents = "none";

        // Mark that we're in playing state
        startMenu.dataset.gameState = "playing";

        // Delay before missiles start (2 seconds after menu fades)
        setTimeout(() => {
          // Activate missiles and set game as fully started
          if (window.gameAPI) {
            window.gameAPI.missilesActive = true;
            window.gameAPI.gameStarted = true;
          }

          // Dispatch custom event so other components can react
          window.dispatchEvent(new CustomEvent("gamestart"));

          // Reset processing flag
          isProcessingStart = false;
        }, 2500); // 500ms fade + 2000ms delay
      };

      const handleKeyDown = (event: KeyboardEvent) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handleStart();
        }
      };

      const handleGameOver = () => {
        // Stop the game
        if (window.gameAPI) {
          window.gameAPI.gameStarted = false;
          window.gameAPI.playerCanMove = false;
          window.gameAPI.missilesActive = false;
        }

        // Update menu state and button text
        startMenu.dataset.gameState = "gameover";
        startButton.textContent = "Restart Game";

        // Show the menu again
        startMenu.style.opacity = "1";
        startMenu.style.pointerEvents = "auto";

        // Re-focus the button
        startButton.focus();
      };

      // Start on button click
      startButton.addEventListener("click", handleStart);

      // Also support pressing Enter or Space when button is focused
      startButton.addEventListener("keydown", handleKeyDown);

      // Listen for game over event
      window.addEventListener("gameover", handleGameOver);

      // Auto-focus the button for keyboard accessibility
      startButton.focus();

      // Cleanup function to remove event listeners
      const cleanup = () => {
        startButton.removeEventListener("click", handleStart);
        startButton.removeEventListener("keydown", handleKeyDown);
        window.removeEventListener("gameover", handleGameOver);
        // Clean up global API
        if (window.gameAPI?.showStartMenu) {
          delete window.gameAPI.showStartMenu;
        }
        if (window.gameAPI?.restart) {
          delete window.gameAPI.restart;
        }
      };

      // Cleanup on page navigation (Astro view transitions)
      document.addEventListener("astro:before-preparation", cleanup);
      document.addEventListener("astro:page-load", cleanup);

      // Global restart function to reset all game components
      const restartGame = () => {
        // Reset nighthawk position
        if (window.gameAPI?.nighthawk?.reset) {
          window.gameAPI.nighthawk.reset();
        }

        // Reset missiles
        if (window.gameAPI?.missiles?.restartGame) {
          window.gameAPI.missiles.restartGame();
        }
      };

      // Expose functions for external use
      window.gameAPI.showStartMenu = handleGameOver;
      window.gameAPI.restart = restartGame;
    }
  </script>
</div>
