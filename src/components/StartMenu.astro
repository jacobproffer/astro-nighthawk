---
// StartMenu component - Displays the initial overlay before game starts
---

<div
  id="start-menu"
  class="fixed inset-0 z-50 flex flex-col items-center justify-center gap-8 bg-black/90 transition-opacity duration-500"
  data-game-state="initial"
>
  <h1 class="text-6xl font-bold text-white tracking-widest uppercase">
    Nighthawk
  </h1>
  <button
    id="start-button"
    class="px-12 py-4 border-4 border-white text-white text-2xl font-semibold tracking-wide hover:bg-gray-700 hover:text-gray-200 transition-all duration-200 cursor-pointer select-none"
  >
    Begin Game
  </button>
</div>

<script>
  const startMenu = document.getElementById("start-menu");
  const startButton = document.getElementById("start-button");

  if (startMenu && startButton) {
    // Notify the game that we're in "waiting to start" state
    if (!window.gameAPI) {
      window.gameAPI = {};
    }
    window.gameAPI.gameStarted = false;
    window.gameAPI.playerCanMove = false;
    window.gameAPI.missilesActive = false;

    let isProcessingStart = false;

    const handleStart = () => {
      // Prevent multiple invocations
      if (isProcessingStart) {
        return;
      }
      isProcessingStart = true;

      const isRestart = startMenu.dataset.gameState === "gameover";

      // Reset game state if restarting
      if (isRestart && window.gameAPI?.restart) {
        window.gameAPI.restart();
      }

      // Allow player to move immediately
      if (window.gameAPI) {
        window.gameAPI.playerCanMove = true;
      }

      // Fade out the menu
      startMenu.style.opacity = "0";
      startMenu.style.pointerEvents = "none";

      // Mark that we're in playing state
      startMenu.dataset.gameState = "playing";

      // Delay before missiles start (2 seconds after menu fades)
      setTimeout(() => {
        // Activate missiles and set game as fully started
        if (window.gameAPI) {
          window.gameAPI.missilesActive = true;
          window.gameAPI.gameStarted = true;
        }

        // Dispatch custom event so other components can react
        window.dispatchEvent(new CustomEvent("gamestart"));

        // Reset processing flag
        isProcessingStart = false;
      }, 2500); // 500ms fade + 2000ms delay
    };

    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        handleStart();
      }
    };

    const handleGameOver = () => {
      // Stop the game
      if (window.gameAPI) {
        window.gameAPI.gameStarted = false;
        window.gameAPI.playerCanMove = false;
        window.gameAPI.missilesActive = false;
      }

      // Update menu state and button text
      startMenu.dataset.gameState = "gameover";
      startButton.textContent = "Restart Game";

      // Show the menu again
      startMenu.style.opacity = "1";
      startMenu.style.pointerEvents = "auto";

      // Re-focus the button
      startButton.focus();
    };

    // Start on button click
    startButton.addEventListener("click", handleStart);

    // Also support pressing Enter or Space when button is focused
    startButton.addEventListener("keydown", handleKeyDown);

    // Listen for game over event
    window.addEventListener("gameover", handleGameOver);

    // Auto-focus the button for keyboard accessibility
    startButton.focus();

    // Cleanup function to remove event listeners
    const cleanup = () => {
      startButton.removeEventListener("click", handleStart);
      startButton.removeEventListener("keydown", handleKeyDown);
      window.removeEventListener("gameover", handleGameOver);
      // Clean up global API
      if (window.gameAPI?.showStartMenu) {
        delete window.gameAPI.showStartMenu;
      }
      if (window.gameAPI?.restart) {
        delete window.gameAPI.restart;
      }
    };

    // Cleanup on page navigation (Astro view transitions)
    document.addEventListener("astro:before-preparation", cleanup);
    document.addEventListener("astro:page-load", cleanup);

    // Global restart function to reset all game components
    const restartGame = () => {
      // Reset nighthawk position
      if (window.gameAPI?.nighthawk?.reset) {
        window.gameAPI.nighthawk.reset();
      }

      // Reset missiles
      if (window.gameAPI?.missiles?.restartGame) {
        window.gameAPI.missiles.restartGame();
      }
    };

    // Expose functions for external use
    window.gameAPI.showStartMenu = handleGameOver;
    window.gameAPI.restart = restartGame;
  }
</script>
